# Compose CI pipeline
x-documentation: >
  # Compose CI:

  ## Requirements

  ## Start the CI pipeline

  ```bash
  docker compose -f 02.compose.ci.yml up --build
  ```
  > you can even use the watch mode to test and debug your CI pipeline.

  ## About variable interpolation

  - https://docs.docker.com/reference/compose-file/interpolation/

x-common-variables: &common-variables
  # Define global variables for the CI pipeline  
  GLOBAL_WASM_BUILD_MESSAGE: "â˜‚ï¸ Building Go wasm plugins"
  GLOBAL_BINARY_BUILD_MESSAGE: "ğŸ“¦ Building Go binaries"

services:

  # Run unit tests for the wasm plugin
  test-wasm-go-plugin:
    #image: tinygo/tinygo:0.39.0
    image: golang:1.24.0-alpine
    environment:
      <<: *common-variables
    command:
      - /bin/sh
      - -c
      - |
        echo "ğŸ§ª Running unit tests for wasm plugin"
        cd /go-plugin/logic
        go mod download
        mkdir -p /reports
        if go test -v -json > /reports/wasm-plugin-test-report.json; then
          echo "âœ… Wasm plugin tests completed"
          echo "ğŸ“„ Test report generated at /reports/wasm-plugin-test-report.json"
          exit 0
        else
          echo "âŒ Wasm plugin tests failed"
          exit 1
        fi

    volumes:
      - ./plugins/go-plugin:/go-plugin
      - ./reports:/reports

  # Run unit tests for the cracker runner
  test-cracker-runner:
    image: golang:1.24.0-alpine
    command:
      - /bin/sh
      - -c
      - |
        echo "ğŸ§ª Running unit tests for cracker runner"
        cd /cracker-runner
        go mod download
        mkdir -p /reports
        if go test -v -json > /reports/cracker-runner-test-report.json; then
          echo "âœ… Cracker runner tests completed"
          echo "ğŸ“„ Test report generated at /reports/cracker-runner-test-report.json"
          exit 0
        else
          echo "âŒ Cracker runner tests failed"
          exit 1
        fi

    volumes:
      - ./cracker-runner:/cracker-runner
      - ./reports:/reports


  # Build the wasm file using tinygo
  build-wasm-go-plugin:
    image: tinygo/tinygo:0.39.0
    environment:
      <<: *common-variables
      LOCAL_WASM_BUILD_MESSAGE: "ğŸŸ£ Building the say_hello wasm plugin"

    command: 
    # ${ABOUT} and ${AUTHOR} are defined into the .env file
    # they are automatically picked up by docker compose
    # $${GLOBAL_WASM_BUILD_MESSAGE} is defined in the common variables section
      - /bin/sh
      - -c
      - |  
        go version
        tinygo version
        # Use double $$ to escape $ in docker compose command
        echo "$${GLOBAL_WASM_BUILD_MESSAGE}"
        echo "$${LOCAL_WASM_BUILD_MESSAGE}"
        echo "âœ‹ about: ${ABOUT}, by ${AUTHOR}"
        cd /go-plugin
        go mod download
        tinygo build \
          -scheduler=none \
          --no-debug \
          -o /build/plugin.wasm \
          -target wasi main.go
        echo "ğŸ“¦ plugin.wasm built at /build/plugin.wasm"
      
    volumes:
      - ./plugins/go-plugin:/go-plugin
      - ./build:/build
    depends_on:
      test-wasm-go-plugin:
        condition: service_completed_successfully

  # Build the cracker runner binary
  build-cracker-runner:
    image: golang:1.24.0-alpine
    environment:
      TARGETOS: ${TARGETOS:-darwin}
      TARGETARCH: ${TARGETARCH:-arm64}
    command:
      - /bin/sh
      - -c
      - |
        echo "$${GLOBAL_BINARY_BUILD_MESSAGE}"
        echo "ğŸ“¦ building cracker runner on $${TARGETOS}/$${TARGETARCH}"
        cd /cracker-runner
        go mod download
        CGO_ENABLED=0 GOOS=$${TARGETOS} GOARCH=$${TARGETARCH} go build \
          -ldflags="-s -w" \
          -o /build/cracker-runner-$${TARGETOS}-$${TARGETARCH} main.go

        chmod +x /build/cracker-runner-$${TARGETOS}-$${TARGETARCH}
        echo "ğŸ“¦ cracker runner built at /build/cracker-runner-$${TARGETOS}-$${TARGETARCH}"

    volumes:
      - ./cracker-runner:/cracker-runner
      - ./build:/build
    depends_on:
      test-cracker-runner:
        condition: service_completed_successfully


